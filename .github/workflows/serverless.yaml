name: Pipeline
on:
  push:
    branches:
  workflow_dispatch:

jobs:
  localstack:
    runs-on: ubuntu-latest
    services:
      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: lambda
          DEFAULT_REGION: ${{secrets.AWS_REGION}}
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        ports:
          - 4566:4566
          - 4571:4571
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          npm i
      # Execute Tests lambda
      - name: Run test for sample lambda
        run: |
          npm run test

  dev_plan:
    name: plan dev
    runs-on: ubuntu-latest
    needs: localstack
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Check Node Version
        run: |
          node --version

      - name: Check NPM Version
        run: |
          npm --version

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Log AWS Account
        run: |
          aws sts get-caller-identity --output text

  dev_deploy:
    name: deploy dev
    environment: dev
    runs-on: ubuntu-latest
    needs:
      - "dev_plan"
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          aws-region: ${{secrets.AWS_REGION}}

      - name: Install dependencies
        run: |
          export BASE_DIR=$(pwd)
          cd $BASE_DIR
          npm i

      - name: serverless deploy
        uses: serverless/github-action@v3.1
        with:
          args: -c "serverless deploy --stage dev --region ${{secrets.AWS_REGION}}"
          entrypoint: /bin/sh
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
